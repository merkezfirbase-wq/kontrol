<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CGA G√ºvenlik Sistemi - Kullanƒ±cƒ± Paneli</title>
<link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600&display=swap" rel="stylesheet">
<style>
body { margin:0; font-family:'Montserrat', sans-serif; background: linear-gradient(135deg, #1f3c59, #2c5364); color:#ecf0f1; }
.container { max-width: 1000px; margin:20px auto; padding:20px; position: relative; }
h1,h2 { text-align:center; margin-bottom:0; }
.panel { background: rgba(255,255,255,0.05); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.4); margin-top:20px; position:relative; }
.status { margin-top:10px; padding:15px; background: rgba(0,0,0,0.2); border-radius:12px; font-size:15px; line-height:1.5; }
.devriye-list { max-height:450px; overflow-y:auto; margin-top:10px; }
.devriye-item { display:flex; flex-direction:column; background: rgba(0,0,0,0.2); border-radius:12px; margin-bottom:12px; padding:12px; transition:0.3s; }
.devriye-item:hover { background: rgba(0,0,0,0.35); }
.devriye-left { flex:1; min-width:180px; margin-right:10px; }
.devriye-status { font-weight:bold; font-size:16px; text-align:center; min-width:140px; padding:8px; border-radius:12px; margin-top:10px; }
.devriye-status.tam { background: #2ecc71; color:#fff; }
.devriye-status.eksik { background: #e74c3c; color:#fff; }
.devriye-points { margin-top:8px; font-size:14px; background: rgba(255,255,255,0.05); padding:6px; border-radius:8px; }

.security-item { display:flex; align-items:center; justify-content: space-between; background: rgba(0,0,0,0.2); padding:8px 12px; border-radius:10px; margin-bottom:6px; font-size:15px; }
.security-item:hover { background: rgba(0,0,0,0.35); }
.security-left { display:flex; align-items:center; gap:10px; }
.security-light { width:10px; height:10px; background:#2ecc71; border-radius:50%; flex-shrink:0; }
.security-name { font-weight:600; }

input[type=date], input[type=password], input[type=text] { padding:6px; border-radius:8px; border:none; outline:none; margin-top:5px; }

#profileModal { display:none; position:fixed; top:50%; left:50%; transform: translate(-50%,-50%); background: rgba(30,30,30,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.5); z-index:9999; width:90%; max-width:400px; }
#profileModal h3 { text-align:center; margin-bottom:10px; }
#profileModal label { display:block; margin-top:10px; font-size:14px; text-transform: uppercase; } 
#profileModal input { width:100%; }
#profileModal button { margin-top:15px; padding:8px 12px; border-radius:8px; border:none; cursor:pointer; font-weight:600; }
#updatePasswordBtn { background:#27ae60; color:#fff; }
#updatePasswordBtn:hover { background:#2ecc71; }
#profileClose { position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; color:#fff; }

#profileUsername { color:#fff; } 

.togglePassword {
  position:absolute; right:10px; top:50%; transform:translateY(-50%);
  cursor:pointer; font-size:16px; user-select:none;
}

.top-right-actions { position: fixed; top: 10px; right: 20px; display:flex; align-items:center; gap:10px; z-index:1000; }
#profileIcon { position: relative; background: #27ae60; width:45px; height:45px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-size:22px; cursor:pointer; z-index:10; }
#messageBtn { width:45px; height:45px; border-radius:50%; background:#3498db; display:flex; align-items:center; justify-content:center; font-size:18px; cursor:pointer; position:relative; box-shadow:0 4px 10px rgba(0,0,0,0.25); }
#messageBadge { position:absolute; top:-5px; right:-5px; background:#2ecc71; color:white; font-size:12px; font-weight:700; width:20px; height:20px; border-radius:50%; display:flex; align-items:center; justify-content:center; }

#cargoBtn { padding: 10px 12px; background:#f39c12; color:#fff; border:none; border-radius:8px; font-weight:600; font-size:14px; cursor:pointer; }
#cargoBtn:hover { background:#e67e22; }
#logoutBtn { padding: 10px 12px; background:#e74c3c; color:#fff; border:none; border-radius:8px; font-weight:600; font-size:14px; cursor:pointer; }
#logoutBtn:hover { background:#c0392b; }

#messageModal { display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); width:90%; max-width:450px; background: rgba(30,30,30,0.95); padding:20px; border-radius:16px; box-shadow:0 6px 20px rgba(0,0,0,0.5); z-index:10000; max-height:80%; overflow-y:auto; flex-direction:column; }
#messageModal h3 { margin-bottom:15px; text-align:center; }
#messageModal .modalClose { position:absolute; top:10px; right:10px; cursor:pointer; font-size:18px; color:#fff; }
.message-item { background: rgba(255,255,255,0.1); padding:10px; border-radius:12px; margin-bottom:10px; cursor:pointer; transition:0.3s; }
.message-item:hover { background: rgba(255,255,255,0.25); display:flex; justify-content: space-between; align-items:center; }
#messageDetail { display:none; flex-direction:column; gap:8px; background: rgba(50,50,50,0.95); padding:15px; border-radius:12px; margin-top:10px; }
#messageDetail h4 { margin:0; font-size:16px; }
#deleteMessageBtn { background:#e74c3c; color:#fff; border:none; border-radius:8px; padding:6px 10px; cursor:pointer; font-weight:600; align-self:flex-end; }

@media (min-width:600px){ .devriye-item { flex-direction: row; justify-content: space-between; align-items: center; } .devriye-left { margin-right:20px; } .devriye-status { margin-top:0; } }
@media (max-width:600px){ .security-item { flex-direction: row; align-items: center; justify-content: space-between; } }

body, div, span, p, h1, h2, h3, h4, h5, h6, label, input, button {
    user-select: none;
    -webkit-user-select: none; 
    -moz-user-select: none;    
    -ms-user-select: none;     
}
.site-name{
  display:none;
  text-align:center;
  font-size:26px;
  font-weight:800;
  margin:10px 0 5px;
  color:#2ecc71;
  letter-spacing:1px;
  text-shadow:
    0 0 10px rgba(46,204,113,0.6),
    0 0 25px rgba(46,204,113,0.4);
  animation: glowIn .6s ease;
}

@keyframes glowIn{
  from{
    opacity:0;
    transform:translateY(-6px);
  }
  to{
    opacity:1;
    transform:translateY(0);
  }
}

</style>
</head>
<body>

<div class="container">
  <h1>CGA G√ºvenlik Sistemi</h1>
  <div id="siteName" class="site-name"></div>
  <h2>Kullanƒ±cƒ± Paneli</h2>

  <div id="profileModal">
    <span id="profileClose">‚úñ</span>
    <h3>Profil</h3>
    <label>Kullanƒ±cƒ± Adƒ± (deƒüi≈ütirilemez)</label>
    <input type="text" id="profileUsername" disabled>
    <label>ESKƒ∞ ≈ûƒ∞FRE</label>
    <div style="position:relative;">
      <input type="password" id="oldPassword">
      <span class="togglePassword" data-target="oldPassword">üëÄ</span>
    </div>
    <label>YENƒ∞ ≈ûƒ∞FRE</label>
    <div style="position:relative;">
      <input type="password" id="newPassword">
      <span class="togglePassword" data-target="newPassword">üëÄ</span>
    </div>
    <button id="updatePasswordBtn">≈ûifreyi G√ºncelle</button>
    <div id="profileMessage" style="margin-top:10px;font-size:14px;"></div>
  </div>

  <div class="panel">
    <h3>G√ºvenlik Durumu</h3>
    <div id="securityStatus" class="status">Y√ºkleniyor...</div>
  </div>
<div class="panel">
  <h3>Son Denetleme Bilgisi</h3>
  <div id="lastPatrolStatus" class="status">Y√ºkleniyor...</div>
</div>

  <div class="panel">
    <h3>Devriye Ge√ßmi≈üi</h3>
    <label for="filterDate">Tarih Filtrele:</label>
    <input type="date" id="filterDate">
    <div class="devriye-list" id="devriyeHistory"></div>
  </div>
</div>

<div class="top-right-actions">
  <div id="profileIcon" title="Profil">üë§</div>
  <button id="logoutBtn" title="√áƒ±kƒ±≈ü">√áƒ±kƒ±≈ü</button>
</div>


<!-- ================= MESAJ MODAL ================= -->
<div id="messageModal">
  <span class="modalClose">‚úñ</span>
  <h3>Mesajlar</h3>
  <div id="messageList"></div>
  <div id="messageDetail">
    <h4 id="detailSubject"></h4>
    <p id="detailContent"></p>
    <button id="deleteMessageBtn">Sil</button>
  </div>
</div>

<script type="module">
import { initializeApp, getApps } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase, ref, onValue, push, set, update, get } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

/* === QR ile se√ßilen site Firebase === */
const siteID = localStorage.getItem("siteID");
const siteConfigStr = localStorage.getItem("siteConfig");

if (!siteID || !siteConfigStr) {
  alert("Site baƒülantƒ±sƒ± yok. L√ºtfen QR kodu tekrar okutunuz.");
  window.location.href = "index.html";
}

const siteConfig = JSON.parse(siteConfigStr);

// Aynƒ± siteye tekrar baƒülan
let app = getApps().find(a => a.name === `siteApp-${siteID}`);
if (!app) {
  app = initializeApp(siteConfig, `siteApp-${siteID}`);
}

const db = getDatabase(app);
// üîπ SON DEVRIYE Bƒ∞LGƒ∞Sƒ∞ ENTEGRASYONU
import { initializeApp as initApp2 } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-app.js";
import { getDatabase as getDb2, ref as ref2, get as get2 } from "https://www.gstatic.com/firebasejs/12.1.0/firebase-database.js";

// Mevcut Firebase
const currentApp2 = app;   // Senin mevcut Kullanƒ±cƒ± Paneli Firebase app'i
const currentDb2 = db;

// Yeni Firebase (projeleri √ßekmek i√ßin)
const newFirebaseConfig = {
  apiKey: "AIzaSyDF6XwfMwASz1mHt16DrR9jjjpozP4MBlA",
  authDomain: "denetleme-78b55.firebaseapp.com",
  databaseURL: "https://denetleme-78b55-default-rtdb.firebaseio.com",
  projectId: "denetleme-78b55",
  storageBucket: "denetleme-78b55.firebasestorage.app",
  messagingSenderId: "762780340283",
  appId: "1:762780340283:web:da64465ec4657307f64c1e",
  measurementId: "G-H49EVRYPY9"
};
const newApp = initApp2(newFirebaseConfig, "newApp");
const newDb = getDb2(newApp);

async function getDynamicLastPatrolBy() {
  try {
    const settingsSnap = await get2(ref2(currentDb2, "settings/projeId"));
    if (!settingsSnap.exists()) return null;
    const currentProjectId = settingsSnap.val();

    const projectsSnap = await get2(ref2(newDb, "projects"));
    if (!projectsSnap.exists()) return null;

    const projects = projectsSnap.val();
    const targetProject = projects[currentProjectId];
    if (!targetProject || !targetProject.lastPatrolBy) return null;

    const name = targetProject.lastPatrolBy.name || "-";
    const dateStr = targetProject.lastPatrolEndText || "-";

    return { name, dateStr };
  } catch (err) {
    console.error("Son devriye bilgisi alƒ±namadƒ±:", err);
    return null;
  }
}

// Ekrana yazdƒ±r
getDynamicLastPatrolBy().then(lastPatrol => {
  const statusDiv = document.getElementById("lastPatrolStatus");

  if (lastPatrol) {
    // Firebase'den gelen tarih-saat string: "09.02.2026 12:40"
    const dateTimeStr = lastPatrol.dateStr; 
    const [datePart, timePart] = dateTimeStr.split(' '); // ["09.02.2026", "12:40"]

    // G√ºn adƒ±nƒ± almak i√ßin Date objesi olu≈üturuyoruz
    const [day, month, year] = datePart.split('.').map(Number);
    const patrolDate = new Date(year, month - 1, day); // Ay JS'de 0-11

    const weekday = patrolDate.toLocaleDateString('tr-TR', { weekday: 'long' }).toLowerCase();

    // Ekrana yazdƒ±r
    statusDiv.innerHTML = `
      <p><strong>Denetleyen:</strong> <span style="color:#f1c40f;font-weight:bold;">${lastPatrol.name}</span></p>
      <p><strong>Denetlenme Tarihi:</strong> <span style="color:#1abc9c;font-weight:bold;">${datePart} (${weekday})</span></p>
      <p><strong>Denetleme Saati:</strong> <span style="color:#1abc9c;font-weight:bold;">${timePart}</span></p>
    `;
  } else {
    statusDiv.innerText = "Son devriye bilgisi bulunamadƒ±.";
  }
});



function bildirimModalAc(){
  document.getElementById("bildirildiModal").style.display = "block";
}

const siteNameEl = document.getElementById("siteName");

async function loadSiteName(){
  try{
    const snap = await get(ref(db, "settings/siteName"));

    if(snap.exists()){
      const name = String(snap.val()).trim();
      if(name){
        siteNameEl.textContent = name;
        siteNameEl.style.display = "block";
      }
    }
  }catch(e){
    console.error("Site adƒ± okunamadƒ±:", e);
  }
}

loadSiteName();


let storedUser = sessionStorage.getItem("currentUser");
let currentUser = storedUser ? JSON.parse(storedUser).username : null;
if(!currentUser){ alert("L√ºtfen √∂nce giri≈ü yapƒ±n!"); window.location.href="index.html"; }

const securityStatus=document.getElementById("securityStatus"),
      devriyeHistoryEl=document.getElementById("devriyeHistory"),
      filterDate=document.getElementById("filterDate"),
      profileModal=document.getElementById("profileModal"),
      profileIcon=document.getElementById("profileIcon"),
      profileClose=document.getElementById("profileClose"),
      profileUsername=document.getElementById("profileUsername"),
      oldPassword=document.getElementById("oldPassword"),
      newPassword=document.getElementById("newPassword"),
      updatePasswordBtn=document.getElementById("updatePasswordBtn"),
      logoutBtn=document.getElementById("logoutBtn"),
      cargoBtn=document.getElementById("cargoBtn");

profileUsername.value=currentUser;
profileIcon.addEventListener('click',()=>{profileModal.style.display='block';});
profileClose.addEventListener('click',()=>{profileModal.style.display='none';});
logoutBtn.addEventListener('click',()=>{sessionStorage.removeItem("currentUser"); window.location.href='index.html';});

updatePasswordBtn.addEventListener('click',async()=>{
  profileMessage.innerText='';
  const oldPwd=oldPassword.value; const newPwd=newPassword.value;
  if(!oldPwd||!newPwd){profileMessage.innerText='L√ºtfen eski ve yeni ≈üifreyi giriniz.'; return;}
  try{
    const snapshot=await get(ref(db,'users/'+currentUser));
    if(!snapshot.exists()){profileMessage.innerText='Kullanƒ±cƒ± bulunamadƒ±.'; return;}
    const userData=snapshot.val();
    if(userData.password!==oldPwd){profileMessage.innerText='Eski ≈üifre hatalƒ±.'; return;}
    await update(ref(db,'users/'+currentUser),{password:newPwd});
    profileMessage.innerText='≈ûifre ba≈üarƒ±yla g√ºncellendi.';
    setTimeout(()=>{profileMessage.innerText='';}, 3000);
    oldPassword.value=''; newPassword.value='';
  }catch(err){profileMessage.innerText='Hata olu≈ütu: '+err.message;}
});
[oldPassword, newPassword].forEach(input => { input.addEventListener('input', () => { input.value = input.value.toUpperCase(); }); });
document.querySelectorAll('.togglePassword').forEach(icon=>{ icon.addEventListener('click', ()=>{ const input = document.getElementById(icon.dataset.target); input.type = input.type === 'password' ? 'text' : 'password'; }); });

onValue(ref(db,'nobetRecords'),snapshot=>{
  const val=snapshot.val(); securityStatus.innerHTML='';
  if(!val){ securityStatus.innerText='≈ûu anda n√∂bette g√ºvenlik yok.'; return; }
  let count=0;
  for(const key in val){
    const record=val[key];
    if(record.status==='started'){
      const userName=record.startBy, shift=record.shift, startTime=new Date(record.startTime).toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
      get(ref(db,'users/'+userName)).then(userSnap=>{
        if(!userSnap.exists()) return;
        const phone=userSnap.val()?.phone||'';
        const div=document.createElement('div'); div.classList.add('security-item');
        div.innerHTML=`<div class="security-left"><span style="color:#2ecc71; font-weight:bold;">[‚óè]</span><span class="security-name">${userName} N√∂bette</span> | ${shift} Vardiyasƒ± | ${record.startPoint}</div><button class="call-btn" onclick="window.location.href='tel:${phone}'">üìûAra</button>`;
        securityStatus.appendChild(div);
      });
      count++;
    }
  }
  if(count===0) securityStatus.innerText='≈ûu anda n√∂bette g√ºvenlik yok.';
});

// === DEVRIYE GE√áMƒ∞≈ûƒ∞ ===
let allDevriyeHistory=[], tumNoktalar=[];
onValue(ref(db,'qrCodes'), snapshot=>{ 
  const val=snapshot.val(); 
  tumNoktalar=[]; 
  if(val) for(const key in val){ const qr=val[key]; if(qr.name) tumNoktalar.push(qr.name); }
});
filterDate.value=getTurkeyToday();
onValue(ref(db,'devriyeHistory'), snapshot=>{
  const val=snapshot.val(); allDevriyeHistory=[];
  if(val){
    for(const userKey in val){
      const userRecords=val[userKey];
      for(const recordKey in userRecords){ 
        const record=userRecords[recordKey]; 
     allDevriyeHistory.push({
  ...record,
  userName: record.name,
  devriyeId: record.timestamp   // üî¥ SABƒ∞T ve TEKƒ∞L ID
});

      }
    } 
    allDevriyeHistory.sort((a,b)=>b.timestamp-a.timestamp);
  }
  renderDevriyeHistory();
});
filterDate.addEventListener('change', renderDevriyeHistory);
function hesaplaDevriyeSuresi(start, end){
  if(!start || !end) return '';

  const [sh, sm] = start.split(':').map(Number);
  const [eh, em] = end.split(':').map(Number);

  let startMinutes = sh * 60 + sm;
  let endMinutes = eh * 60 + em;

  // Gece sarkmasƒ± (23:30 ‚Üí 01:00 gibi)
  if(endMinutes < startMinutes){
    endMinutes += 24 * 60;
  }

  const diff = endMinutes - startMinutes;
  const hours = Math.floor(diff / 60);
  const minutes = diff % 60;

  let sonuc = 'Toplam Devriye S√ºre: ';
  if(hours > 0) sonuc += `${hours} saat `;
  sonuc += `${minutes} dakika`;

  return sonuc;
}


async function renderDevriyeHistory(){
  const selectedDate = filterDate.value;
  devriyeHistoryEl.innerHTML = '';

  const filtered = allDevriyeHistory.filter(d => {
    const ts = d.timestamp;
    const dateObj = new Date(ts);
    const utc = dateObj.getTime() + (dateObj.getTimezoneOffset() * 60000);
    const turkeyTime = new Date(utc + 3*60*60*1000);
    const year = turkeyTime.getFullYear();
    const month = String(turkeyTime.getMonth()+1).padStart(2,'0');
    const day = String(turkeyTime.getDate()).padStart(2,'0');
    const devriyeDateStr = `${year}-${month}-${day}`;
    return selectedDate ? devriyeDateStr === selectedDate : true;
  });

  for(const d of filtered){
    const div = document.createElement('div'); 
    div.classList.add('devriye-item');
    const left = document.createElement('div'); 
    left.classList.add('devriye-left');

    let pointsHTML = '';

if(d.status.toLowerCase().includes('eksik')){
  let kaydedilenNoktalar = d.points || [];
let qrRefPath;

if(d.block){
  // d.block deƒüerini aynen al, sonuna "qrcodes" ekle
  const blockFieldName = d.block + 'qrcodes';

  const blockSnapshot = await get(ref(db, blockFieldName));
  if(blockSnapshot.exists()){
    qrRefPath = blockFieldName; // blok bazlƒ± QR
  } else {
    qrRefPath = 'qrCodes';      // yoksa genel QR
  }
} else {
  qrRefPath = 'qrCodes';        // block yoksa genel
}



  try{
    const snapshot = await get(ref(db, qrRefPath));
    let blokNoktalar = [];
    if(snapshot.exists()){
      const val = snapshot.val();
      for(const key in val){ if(val[key].name) blokNoktalar.push(val[key].name); }
    }
    const isaretlenmeyen = blokNoktalar.filter(p => !kaydedilenNoktalar.includes(p));d.missingPoints = isaretlenmeyen;
    pointsHTML = `<div class="devriye-points"><strong>Eksik Noktalar:</strong> ${isaretlenmeyen.join(', ')}</div>`;
  }catch(err){ console.error('QR noktalarƒ± alƒ±namadƒ±:', err); }
}

const toplamSure = hesaplaDevriyeSuresi(d.start, d.end);

left.innerHTML = `
  <div><strong>G√ºvenlik:</strong> ${d.userName}</div>
  <div><strong>Tarih:</strong> ${d.displayDate}</div>
  <div><strong>Ba≈ülangƒ±√ß:</strong> ${d.start}</div>
  <div><strong>Biti≈ü:</strong> ${d.end}</div>

  <div style="margin-top:6px; font-weight:600; color:#f1c40f;">
    ‚è± ${toplamSure}
  </div>

  ${pointsHTML}
`;


  const statusDiv = document.createElement('div'); 
statusDiv.classList.add('devriye-status'); 
statusDiv.classList.add(d.status.toLowerCase().includes('tam') ? 'tam' : 'eksik'); 
statusDiv.innerHTML = `<span style="cursor:pointer;text-decoration:underline;">${d.status}</span>`;

// Sadece eksik devriyelerde modal a√ßƒ±lsƒ±n
if(d.status.toLowerCase().includes('eksik')){
  statusDiv.onclick = ()=> eksikDevriyeModalAc(d);
} else {
  statusDiv.onclick = null; // tam devriyelerde tƒ±klamayƒ± kapat
}



    div.appendChild(left); 
    div.appendChild(statusDiv); 
    devriyeHistoryEl.appendChild(div);
  }
}

function getTurkeyToday(){
  const now=new Date();
  const utc=now.getTime() + (now.getTimezoneOffset()*60000);
  const turkey=new Date(utc + 3*60*60*1000);
  const mm=String(turkey.getMonth()+1).padStart(2,'0'), dd=String(turkey.getDate()).padStart(2,'0');
  return `${turkey.getFullYear()}-${mm}-${dd}`;
}



const eksikModal = document.getElementById("eksikDevriyeModal");
const eksikText = document.getElementById("eksikDevriyeText");
const eksikList = document.getElementById("eksikNoktalarListesi");
const eksikBildirBtn = document.getElementById("eksikBildirBtn");
const eksikKapatBtn = document.getElementById("eksikModalKapat");
let aktifDevriye = null;
let kapatmaSayac = null;

window.eksikDevriyeModalAc = function(devriye){
  aktifDevriye = devriye;

  eksikText.innerText =
  `G√ºvenlik g√∂revlisi ${devriye.userName} tarafƒ±ndan ${devriye.start}‚Äôte ba≈ülatƒ±lƒ±p ${devriye.end}‚Äôde bitirilen devriyenin eksik olduƒüu tespit edilmi≈ütir.`;

  eksikList.innerHTML = (devriye.missingPoints || [])
    .map(p => `‚Ä¢ ${p}`)
    .join("<br>");

  eksikModal.style.display = "block";

  let saniye = 25;
  eksikKapatBtn.innerText = `Kapat (${saniye})`;

  clearInterval(kapatmaSayac);
  kapatmaSayac = setInterval(() => {
    saniye--;
    eksikKapatBtn.innerText = `Kapat (${saniye})`;
    if (saniye <= 0) modalKapat();
  }, 1000);
};

function modalKapat(){
  clearInterval(kapatmaSayac);
  eksikModal.style.display = "none";
}

eksikKapatBtn.onclick = modalKapat;
const zatenBildirilmisModal = document.getElementById("zatenBildirilmisModal");
const zatenBildirilmisKapatBtn = document.getElementById("zatenBildirilmisKapatBtn");

let zatenBildirimSayac = null;

function zatenBildirilmisModalAc(){
  // üî¥ Arkadaki eksik devriye modalini kapat
  modalKapat();

  zatenBildirilmisModal.style.display = "block";

  let saniye = 10;
  zatenBildirilmisKapatBtn.innerText = `Kapat (${saniye})`;

  clearInterval(zatenBildirimSayac);
  zatenBildirimSayac = setInterval(() => {
    saniye--;
    zatenBildirilmisKapatBtn.innerText = `Kapat (${saniye})`;

    if (saniye <= 0) {
      zatenBildirilmisModalKapat();
    }
  }, 1000);
}

function zatenBildirilmisModalKapat(){
  clearInterval(zatenBildirimSayac);
  zatenBildirilmisModal.style.display = "none";
}

zatenBildirilmisKapatBtn.onclick = zatenBildirilmisModalKapat;

eksikBildirBtn.addEventListener("click", async () => {
  if (!aktifDevriye) return;

  const userKey = currentUser;
  const devriyeKey = aktifDevriye.devriyeId; // sen zaten bunu eklemi≈üsin üëç

  const bildirimRef = ref(
    db,
    `eksikdevriyebildirim/${devriyeKey}/${userKey}`
  );

  try {
    const snapshot = await get(bildirimRef);

if (snapshot.exists()) {
zatenBildirilmisModalAc();
  return;
}


    await update(
      ref(db, `eksikdevriyebildirim/${devriyeKey}`),
      {
        [userKey]: {
          guard: aktifDevriye.userName,
          start: aktifDevriye.start,
          end: aktifDevriye.end,
          missingPoints: aktifDevriye.missingPoints || [],
          reportedBy: userKey,
          createdAt: Date.now()
        }
      }
    );

    bildirimModalAc();
    modalKapat();

  } catch (err) {
    alert("Bildirim g√∂nderilirken hata olu≈ütu");
    console.error(err);
  }
});


</script>
<div id="bildirildiModal" style="
display:none;
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:rgba(20,20,20,0.97);
padding:20px;
border-radius:16px;
max-width:400px;
width:90%;
z-index:30000;
box-shadow:0 8px 30px rgba(0,0,0,0.6);
text-align:center;
">
  <h3>Bildirim G√∂nderildi</h3>
  <p>Eksik devriye bilgisi g√ºvenlik ≈üirketine ba≈üarƒ±yla iletilmi≈ütir.</p>

  <button onclick="document.getElementById('bildirildiModal').style.display='none'" style="
    margin-top:15px;
    width:100%;
    background:#27ae60;
    color:#fff;
    border:none;
    padding:10px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
  ">
    Tamam
  </button>
</div>
<div id="zatenBildirilmisModal" style="
display:none;
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:rgba(20,20,20,0.97);
padding:20px;
border-radius:16px;
max-width:400px;
width:90%;
z-index:30001;
box-shadow:0 8px 30px rgba(0,0,0,0.6);
text-align:center;
">
  <h3 style="color:#f1c40f;">Daha √ñnce Bildirilmi≈ü</h3>
  <p>Bu eksik devriyeyi daha √∂nce g√ºvenlik ≈üirketine bildirdiniz.</p>

<button id="zatenBildirilmisKapatBtn" style="
  margin-top:15px;
  width:100%;
  background:#2c3e50;
  color:#fff;
  border:none;
  padding:10px;
  border-radius:10px;
  font-weight:600;
  cursor:pointer;
">
  Kapat (10)
</button>

</div>

<div id="eksikDevriyeModal" style="
display:none;
position:fixed;
top:50%;
left:50%;
transform:translate(-50%,-50%);
background:rgba(20,20,20,0.97);
padding:20px;
border-radius:16px;
max-width:420px;
width:90%;
z-index:20000;
box-shadow:0 8px 30px rgba(0,0,0,0.6);
">
  <h3 style="text-align:center;margin-top:0;">Eksik Devriye Bildirimi</h3>

  <p id="eksikDevriyeText"></p>

  <strong>Eksik Noktalar:</strong>
  <div id="eksikNoktalarListesi" style="margin-top:5px;"></div>

  <button id="eksikBildirBtn" style="
    margin-top:15px;
    width:100%;
    background:#e74c3c;
    color:#fff;
    border:none;
    padding:10px;
    border-radius:10px;
    font-weight:600;
    cursor:pointer;
  ">
    G√ºvenlik ≈ûirketine Bildir
  </button>

  <button id="eksikModalKapat" style="
    margin-top:10px;
    width:100%;
    background:#2c3e50;
    color:#fff;
    border:none;
    padding:8px;
    border-radius:10px;
  ">
    Kapat
  </button>
</div>

</body>
</html>


